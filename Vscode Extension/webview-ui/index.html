<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Commander</title>
    <style>
      :root {
        --bg: var(--vscode-editor-background);
        --text: var(--vscode-editor-foreground);
        --placeholder: var(--vscode-input-placeholderForeground);
        --border: var(--vscode-panel-border);
        --input-bg: var(--vscode-input-background);
        --panel-bg: var(--vscode-panel-background);
        --panel-header-bg: var(--vscode-editorGroup-background);
        --picker-bg: var(--vscode-input-background);
        --picker-text: var(--vscode-input-foreground);
        --resizer-bg: var(--vscode-panel-border);
        --resizer-handle: var(--vscode-focusBorder);
        --tooltip-bg: var(--vscode-editor-background);
        --tooltip-text: var(--vscode-editor-foreground);
        --btn-primary-bg: var(--vscode-button-background);
        --btn-primary-text: var(--vscode-button-foreground);
        --btn-primary-disabled-bg: var(--vscode-button-secondaryBackground);
        --text-info: var(--vscode-descriptionForeground);
        --text-success: var(--vscode-terminal-ansiGreen);
        --text-warning: var(--vscode-terminal-ansiYellow);
        --text-danger: var(--vscode-terminal-ansiRed);
        --link-active: var(--vscode-focusBorder);
        --link-inactive: var(--vscode-descriptionForeground);
        --checkmark-color: var(--vscode-button-foreground);
        --copy-button-bg: var(--vscode-input-background);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        margin: 0;
        background-color: var(--bg);
        color: var(--text);
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      /* Hide scrollbar but allow scrolling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--panel-header-bg);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--resizer-handle);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--vscode-focusBorder);
      }

      input,
      textarea,
      select,
      button {
        font-family: inherit;
        font-size: 14px; /* Standardize button font size */
      }
      input:focus,
      textarea:focus {
        outline: none;
        border-color: var(--vscode-focusBorder);
      }

      .safe-area {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .app-container {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .main-content {
        flex: 1;
        display: flex;
      }
      .panel {
        display: flex;
        flex-direction: column;
        overflow: hidden;
        flex: 1; /* Ensures 50/50 split by default */
      }
      .panel-body {
        flex: 1;
        background-color: var(--panel-bg);
        overflow-y: auto;
        display: flex; /* Added for full-height content */
        flex-direction: column; /* Added for full-height content */
      }
      .sub-tab-content {
        padding: 15px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        border-bottom: 1px solid var(--border);
      }
      .app-header-title {
        font-size: 20px;
        font-weight: bold;
      }
      .dark-mode-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .top-bar {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: var(--bg);
      }

      .session-bar {
        display: flex;
        align-items: center;
        padding: 5px 10px;
        border-bottom: 1px solid var(--border);
        background-color: var(--bg);
        gap: 8px; /* Increased gap for text buttons */
      }
      .session-picker {
        flex: 1;
        height: 40px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background-color: var(--picker-bg);
        color: var(--picker-text);
        padding: 0 8px;
        font-size: 14px;
      }
      .session-button {
        padding: 8px 12px;
        border: 1px solid var(--border);
        background-color: var(--panel-bg);
        color: var(--text);
        border-radius: 4px;
        cursor: pointer;
        white-space: nowrap;
      }
      .session-button:hover {
        border-color: var(--link-active);
      }

      .method-dropdown {
        height: 40px;
        width: 120px;
        border: 1px solid var(--border);
        border-radius: 4px;
        margin-right: 8px;
        background-color: var(--picker-bg);
        color: var(--picker-text);
        padding: 0 8px;
      }
      .url-input {
        flex: 1;
        height: 40px;
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 0 10px;
        background-color: var(--input-bg);
        color: var(--text);
        font-size: 14px;
      }
      .send-button {
        background-color: var(--btn-primary-bg);
        color: var(--btn-primary-text);
        border-radius: 4px;
        padding: 10px 15px;
        margin-left: 8px;
        border: none;
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
      }
      .send-button:disabled {
        background-color: var(--btn-primary-disabled-bg);
        cursor: not-allowed;
      }

      .tab-container {
        display: flex;
        border-bottom: 1px solid var(--border);
        padding-left: 5px;
        background-color: var(--panel-header-bg);
        flex-shrink: 0;
        flex-wrap: wrap;
      }
      .tab-button {
        padding: 12px;
        cursor: pointer;
        position: relative;
        color: var(--link-inactive);
        border: none;
        background: none;
        font-size: 14px;
      }
      .tab-button.active {
        color: var(--link-active);
        font-weight: 600;
      }
      .tab-button.active::after {
        content: "";
        height: 3px;
        background-color: var(--link-active);
        position: absolute;
        bottom: -1px;
        left: 12px;
        right: 12px;
        border-radius: 2px;
      }

      .sub-tab-container {
        display: flex;
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
        flex-shrink: 0;
      }
      .sub-tab-button {
        padding: 12px;
        cursor: pointer;
        position: relative;
        color: var(--link-inactive);
        border: none;
        background: none;
      }
      .sub-tab-button.active {
        color: var(--text);
        font-weight: bold;
      }
      .sub-tab-button.active::after {
        content: "";
        height: 2px;
        background-color: var(--link-active);
        position: absolute;
        bottom: 0;
        left: 12px;
        right: 12px;
      }

      .kv-container {
        margin-top: 10px;
      }
      .param-row {
        display: flex;
        align-items: center;
        margin: 0 10px 10px 10px;
        gap: 8px;
      }
      .param-row .checkbox-container {
        width: 18px;
        height: 18px;
        border: 1.5px solid var(--placeholder);
        border-radius: 2px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .param-row input[type="checkbox"] {
        display: none;
      }
      .param-row .checkmark {
        color: var(--checkmark-color);
        font-weight: bold;
        font-size: 14px;
        display: none;
      }
      .param-row input[type="checkbox"]:checked + .checkbox-container {
        background-color: var(--btn-primary-bg);
        border-color: var(--btn-primary-bg);
      }
      .param-row
        input[type="checkbox"]:checked
        + .checkbox-container
        .checkmark {
        display: block;
      }

      .param-input {
        flex: 1;
        height: 38px;
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 0 10px;
        background-color: var(--input-bg);
        color: var(--text);
      }
      .file-button {
        flex: 1;
        height: 38px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background-color: var(--input-bg);
        display: flex;
        align-items: center;
        padding: 0 10px;
        color: var(--text);
        cursor: pointer;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }
      .form-type-dropdown {
        width: 85px;
        height: 38px;
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 0 8px;
        background-color: var(--input-bg);
        color: var(--text);
      }
      .remove-button {
        padding: 8px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 22px;
        color: var(--text-danger);
      }

      .auth-input {
        width: 100%;
        height: 40px;
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 0 10px;
        margin-bottom: 10px;
        background-color: var(--input-bg);
        color: var(--text);
      }
      .json-input,
      .raw-headers-input {
        flex-grow: 1; /* Allow textarea to grow */
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 10px;
        background-color: var(--input-bg);
        font-size: 13px;
        color: var(--text);
        resize: vertical;
      }
      .json-input.invalid,
      .raw-headers-input.invalid {
        border: 2px solid var(--text-danger);
      }
      .input-container {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .input-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }
      .input-label {
        font-weight: 600;
        font-size: 14px;
      }
      .prettify-button {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 2px 6px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: none;
        color: var(--link-inactive);
        cursor: pointer;
      }

      .response-top-section {
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }
      .status-info-bar {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        padding: 10px 20px;
        background-color: var(--panel-header-bg);
        flex-wrap: wrap;
        gap: 20px;
      }
      .status-text {
        font-size: 13px;
        font-weight: bold;
      }
      .status-text .value {
        font-weight: normal;
      }
      .status-text .value.success {
        color: var(--text-success);
      }
      .status-text .value.warning {
        color: var(--text-warning);
      }
      .status-text .value.error {
        color: var(--text-danger);
      }
      .status-text .value.info {
        color: var(--text-info);
      }

      .response-body-container {
        /* New wrapper for full-height content */
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
      }
      .response-body-container textarea {
        flex: 1;
        width: 100%;
        border: none;
        background: none;
        color: var(--text);
        padding: 10px;
        font-size: 13px;
        resize: none;
      }
      .promo-text {
        color: var(--text-info);
        text-align: center;
        margin: auto;
      }

      .copy-button-container {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
      }
      .copy-button {
        display: flex;
        align-items: center;
        background-color: var(--copy-button-bg);
        padding: 6px 10px;
        border-radius: 4px;
        gap: 5px;
        border: none;
        cursor: pointer;
        color: var(--link-active);
        font-weight: 600;
        font-size: 13px;
      }

      .resizer {
        flex-shrink: 0;
        background-color: var(--resizer-bg);
      }
      .resizer.horizontal {
        width: 10px;
        cursor: col-resize;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .resizer.horizontal .handle {
        width: 2px;
        height: 30px;
        background-color: var(--resizer-handle);
        border-radius: 2px;
      }
      .resizer.vertical {
        height: 10px;
        cursor: row-resize;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .resizer.vertical .handle {
        height: 2px;
        width: 30px;
        background-color: var(--resizer-handle);
        border-radius: 2px;
      }

      .spinner {
        border: 4px solid var(--resizer-handle);
        border-top: 4px solid var(--btn-primary-bg);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .initial-load-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: var(--bg);
        z-index: 9999;
      }
      .initial-load-container .spinner {
        width: 50px;
        height: 50px;
      }
      .initial-load-container p {
        margin-top: 15px;
        font-size: 16px;
      }

      #toast-container {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }
      .toast {
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-size: 14px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s, transform 0.3s;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .toast.success {
        background-color: var(--text-success);
      }
      .toast.danger {
        background-color: var(--text-danger);
      }
      .toast.warning {
        background-color: #ffc107;
        color: #333;
      }
      .toast.info {
        background-color: #17a2b8;
      }

      .raw-toggle-container {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        padding-right: 15px;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      #new-session-btn {
        background-color: #28a745;
        font-weight: bold;
      }
      #import-session-btn {
        background-color: #fd7e14;
        font-weight: bold;
      }

      #export-session-btn {
        background-color: #007bff;
        font-weight: bold;
      }

      #delete-session-btn {
        background-color: #dc3545;
        font-weight: bold;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--btn-primary-bg);
      }
      input:checked + .slider:before {
        transform: translateX(20px);
      }
    </style>
  </head>
  <body>
    <div class="initial-load-container" id="initial-load-container">
      <div class="spinner"></div>
      <p>Loading Sessions...</p>
    </div>

    <div class="safe-area">
      <header class="app-header">
        <div class="app-header-title">API Commander</div>
      </header>

      <div class="app-container">
        <div class="session-bar">
          <select
            id="session-picker"
            class="session-picker"
            title="Select a session"
          ></select>
          <button id="new-session-btn" class="session-button">
            New Request
          </button>
          <button id="import-session-btn" class="session-button">Import</button>
          <button id="export-session-btn" class="session-button">Export</button>
          <button id="delete-session-btn" class="session-button">Delete</button>
        </div>

        <div class="top-bar">
          <select id="method-dropdown" class="method-dropdown">
            <option>POST</option>
            <option>GET</option>
            <option>PUT</option>
            <option>PATCH</option>
            <option>DELETE</option>
            <option>HEAD</option>
            <option>OPTIONS</option>
          </select>
          <input
            type="text"
            id="url-input"
            class="url-input"
            placeholder="http://api.example.com"
          />
          <button id="send-btn" class="send-button">
            <span>Send</span>
          </button>
        </div>

        <main class="main-content" id="main-content">
          <div class="panel" id="request-panel">
            <div class="tab-container" id="request-tab-container">
              <button class="tab-button active" data-tab="Body">Body</button>
              <button class="tab-button" data-tab="Query">Query</button>
              <button class="tab-button" data-tab="Headers">Headers</button>
              <button class="tab-button" data-tab="Cookies">Cookies</button>
              <button class="tab-button" data-tab="Auth">Auth</button>
            </div>
            <div class="panel-body" id="request-panel-body"></div>
          </div>

          <div class="resizer" id="resizer">
            <div class="handle"></div>
          </div>

          <div class="panel" id="response-panel">
            <div class="response-top-section">
              <div class="status-info-bar">
                <span class="status-text"
                  >Status:
                  <span id="res-status" class="value info">-</span></span
                >
                <span class="status-text"
                  >Size: <span id="res-size" class="value info">-</span></span
                >
                <span class="status-text"
                  >Time: <span id="res-time" class="value info">-</span></span
                >
              </div>
              <div class="tab-container" id="response-tab-container">
                <button class="tab-button active" data-tab="Response">
                  Response
                </button>
                <button class="tab-button" data-tab="Headers">Headers</button>
                <button class="tab-button" data-tab="Cookies">Cookies</button>
              </div>
            </div>
            <div class="panel-body" id="response-panel-body"></div>
          </div>
        </main>
      </div>
    </div>
    <div id="toast-container"></div>
    <input
      type="file"
      id="file-importer"
      style="display: none"
      accept="application/json"
    />
    <input type="file" id="form-file-picker" style="display: none" />

    <script>
      localStorage.clear();
      // ====================================================================================
      //                                  JAVASCRIPT LOGIC
      // ====================================================================================
      document.addEventListener("DOMContentLoaded", () => {
        // ==================== Constants & Defaults ====================

        let vscode;
        try {
          vscode = acquireVsCodeApi();
        } catch (e) {
          console.error("Failed to acquire VSCode API:", e);
          // Provide a mock for running in a browser
          vscode = {
            postMessage: (message) =>
              console.log("Message to VSCode:", message),
            getState: () => ({}),
            setState: () => {},
          };
        }

        const ASYNC_STORAGE_KEYS = {
          ALL_SESSIONS: "@apicommander_all_keys",
          SESSION_PREFIX: "@apicommander_session_",
          LAST_ACTIVE: "@apicommander_last_active_key",
          DARK_MODE: "@apicommander_dark_mode",
        };

        const emptyKeyValue = { key: "", value: "", enabled: true };
        const emptyFormValue = {
          key: "",
          value: "",
          type: "text",
          file: null,
          enabled: true,
        };

        const getDefaultState = () => ({
          httpMethod: "POST",
          url: "",
          requestTab: "Body",
          queryParams: [{ id: Date.now(), ...emptyKeyValue }],
          headers: [
            {
              id: Date.now() + 1,
              key: "User-Agent",
              value: "API Commander/2.0.0",
              enabled: true,
            },
            { id: Date.now() + 2, ...emptyKeyValue },
          ],
          requestCookies: [{ id: Date.now() + 5, ...emptyKeyValue }],
          isRawHeaders: false,
          rawHeadersText: "User-Agent: API Commander/2.0.0",
          authConfig: {
            type: "None",
            basic: { username: "", password: "" },
            bearer: { token: "" },
            // oauth2: {
            //   accessToken: "",
            //   tokenUrl: "",
            //   clientId: "",
            //   clientSecret: "",
            //   scope: "",
            // },
            // aws: {
            //   accessKeyId: "",
            //   secretAccessKey: "",
            //   region: "us-east-1",
            //   service: "execute-api",
            // },
          },
          bodyConfig: {
            type: "JSON",
            jsonContent: '{\n  "id": 101\n}',
            textContent: "",
            xmlContent: "",
            // graphqlQuery: "{ posts { id title } }",
            // graphqlVariables: '{ "limit": 10 }',
            formData: [{ id: Date.now() + 3, ...emptyFormValue }],
            formEncodedData: [{ id: Date.now() + 4, ...emptyKeyValue }],
            binaryFile: null,
          },
        });

        const httpStatusMessages = {
          100: "Continue",
          101: "Switching Protocols",
          200: "OK",
          201: "Created",
          202: "Accepted",
          204: "No Content",
          301: "Moved Permanently",
          302: "Found",
          304: "Not Modified",
          400: "Bad Request",
          401: "Unauthorized",
          403: "Forbidden",
          404: "Not Found",
          405: "Method Not Allowed",
          408: "Request Timeout",
          500: "Internal Server Error",
          501: "Not Implemented",
          502: "Bad Gateway",
          503: "Service Unavailable",
          504: "Gateway Timeout",
        };

        // ==================== Global State & DOM References ====================
        let appState = getDefaultState();
        let sessions = {};
        let activeSessionKey = null;
        let responseState = {
          data: null,
          headers: null,
          status: null,
          size: null,
          time: null,
          error: null,
          responseTab: "Response",
          cookies: [],
        };
        let isLoading = false;
        let isInitialLoad = true;

        const dom = {
          body: document.body,
          initialLoader: document.getElementById("initial-load-container"),
          sessionPicker: document.getElementById("session-picker"),
          newSessionBtn: document.getElementById("new-session-btn"),
          importSessionBtn: document.getElementById("import-session-btn"),
          exportSessionBtn: document.getElementById("export-session-btn"),
          deleteSessionBtn: document.getElementById("delete-session-btn"),
          methodDropdown: document.getElementById("method-dropdown"),
          urlInput: document.getElementById("url-input"),
          sendBtn: document.getElementById("send-btn"),
          mainContent: document.getElementById("main-content"),
          requestPanel: document.getElementById("request-panel"),
          responsePanel: document.getElementById("response-panel"),
          requestTabContainer: document.getElementById("request-tab-container"),
          requestPanelBody: document.getElementById("request-panel-body"),
          responseTabContainer: document.getElementById(
            "response-tab-container"
          ),
          responsePanelBody: document.getElementById("response-panel-body"),
          resStatus: document.getElementById("res-status"),
          resSize: document.getElementById("res-size"),
          resTime: document.getElementById("res-time"),
          resizer: document.getElementById("resizer"),
          toastContainer: document.getElementById("toast-container"),
          fileImporter: document.getElementById("file-importer"),
          formFilePicker: document.getElementById("form-file-picker"),
        };

        // ==================== Utility Functions ====================
        const formatTimeAgo = (timestamp) => {
          const now = Date.now();
          const seconds = Math.floor((now - timestamp) / 1000);
          let interval = seconds / 31536000;
          if (interval > 1) return Math.floor(interval) + " years ago";
          interval = seconds / 2592000;
          if (interval > 1) return Math.floor(interval) + " months ago";
          interval = seconds / 604800;
          if (interval > 1) return Math.floor(interval) + " weeks ago";
          interval = seconds / 86400;
          if (interval > 1) return Math.floor(interval) + " days ago";
          interval = seconds / 3600;
          if (interval > 1) return Math.floor(interval) + " hours ago";
          interval = seconds / 60;
          if (interval > 1) return Math.floor(interval) + " minutes ago";
          return "just now";
        };

        const formatBytes = (bytes, decimals = 2) => {
          if (bytes === null || bytes === undefined) return "-";
          if (bytes === 0) return "0 B";
          const k = 1024;
          const dm = decimals < 0 ? 0 : decimals;
          const sizes = ["B", "KB", "MB", "GB", "TB"];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + " " + sizes[i]
          );
        };

        const isValidJson = (str) => {
          if (typeof str !== "string" || !str.trim()) return true;
          try {
            JSON.parse(str);
          } catch (e) {
            return false;
          }
          return true;
        };

        const showToast = (message, type = "info", duration = 3000) => {
          const toast = document.createElement("div");
          toast.className = `toast ${type}`;
          toast.textContent = message;
          dom.toastContainer.appendChild(toast);
          try {
            vscode.postMessage({
              command: "showToast",
              payload: { text: message },
            });
          } catch (error) {
            console.log(error);
          }
          setTimeout(() => {
            toast.classList.add("show");
          }, 10);
          setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => toast.remove(), 300);
          }, duration);
        };

        const debounce = (func, delay) => {
          let timeout;
          return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
          };
        };

        // ==================== AWS v4 Signing Logic (Native Crypto) ====================
        async function sha256_hex(message) {
          const msgBuffer = new TextEncoder().encode(message);
          const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
        }

        async function hmacSha256(key, data) {
          const keyBuffer =
            typeof key === "string" ? new TextEncoder().encode(key) : key;
          const dataBuffer = new TextEncoder().encode(data);
          const cryptoKey = await crypto.subtle.importKey(
            "raw",
            keyBuffer,
            { name: "HMAC", hash: "SHA-256" },
            false,
            ["sign"]
          );
          return await crypto.subtle.sign("HMAC", cryptoKey, dataBuffer);
        }

        async function getSignatureKey(
          key,
          dateStamp,
          regionName,
          serviceName
        ) {
          const kDate = await hmacSha256("AWS4" + key, dateStamp);
          const kRegion = await hmacSha256(kDate, regionName);
          const kService = await hmacSha256(kRegion, serviceName);
          return await hmacSha256(kService, "aws4_request");
        }

        async function signRequestV4(request, credentials) {
          const { accessKeyId, secretAccessKey, region, service } = credentials;
          const { method, host, path, headers, body } = request;
          const amzDate = new Date().toISOString().replace(/[:-]|\.\d{3}/g, "");
          const dateStamp = amzDate.substr(0, 8);

          const headerEntries = Object.keys(headers).map((key) => [
            key.toLowerCase(),
            headers[key].toString().trim(),
          ]);
          headerEntries.sort((a, b) => a[0].localeCompare(b[0]));

          const canonicalHeaders = headerEntries
            .map(([k, v]) => `${k}:${v}\n`)
            .join("");
          const signedHeaders = headerEntries.map(([k]) => k).join(";");

          const payloadHash = await sha256_hex(body || "");
          const canonicalRequest = `${method}\n${path}\n\n${canonicalHeaders}\n${signedHeaders}\n${payloadHash}`;

          const algorithm = "AWS4-HMAC-SHA256";
          const credentialScope = `${dateStamp}/${region}/${service}/aws4_request`;
          const hashedCanonicalRequest = await sha256_hex(canonicalRequest);
          const stringToSign = `${algorithm}\n${amzDate}\n${credentialScope}\n${hashedCanonicalRequest}`;

          const signingKey = await getSignatureKey(
            secretAccessKey,
            dateStamp,
            region,
            service
          );
          const signatureRaw = await hmacSha256(signingKey, stringToSign);
          const signature = Array.from(new Uint8Array(signatureRaw))
            .map((b) => b.toString(16).padStart(2, "0"))
            .join("");

          const authorizationHeader = `${algorithm} Credential=${accessKeyId}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`;

          return {
            "x-amz-date": amzDate,
            Authorization: authorizationHeader,
            "x-amz-content-sha256": payloadHash,
          };
        }

        // ==================== State Management & Rendering ====================
        function render() {
          dom.methodDropdown.value = appState.httpMethod;
          dom.urlInput.value = appState.url;
          renderTabs(
            dom.requestTabContainer,
            ["Body", "Query", "Headers", "Cookies", "Auth"],
            appState.requestTab
          );
          renderRequestContent();
          renderTabs(
            dom.responseTabContainer,
            ["Response", "Headers", "Cookies"],
            responseState.responseTab
          );
          renderResponseContent();
          renderResponseStatus();
          dom.sendBtn.disabled = isLoading;
          dom.sendBtn.querySelector("span").textContent = isLoading
            ? "Sending..."
            : "Send";
        }

        function renderTabs(container, tabs, activeTab) {
          container.innerHTML = "";
          tabs.forEach((tab) => {
            const button = document.createElement("button");
            button.className = "tab-button";
            button.dataset.tab = tab;
            button.textContent = tab;
            if (tab === activeTab) button.classList.add("active");
            container.appendChild(button);
          });
        }

        function renderSubTabs(container, tabs, activeTab, onTabClick) {
          container.innerHTML = "";
          tabs.forEach((tab) => {
            const button = document.createElement("button");
            button.className = "sub-tab-button";
            button.dataset.tab = tab;
            button.textContent = tab;
            if (tab === activeTab) button.classList.add("active");
            button.onclick = () => onTabClick(tab);
            container.appendChild(button);
          });
        }

        function renderRequestContent() {
          const body = dom.requestPanelBody;
          body.innerHTML = "";
          switch (appState.requestTab) {
            case "Query":
              body.appendChild(
                createKvView(appState.queryParams, "queryParams", {
                  hasCheckbox: true,
                })
              );
              break;
            case "Headers":
              body.appendChild(createHeadersView());
              break;
            case "Cookies":
              body.appendChild(
                createKvView(appState.requestCookies, "requestCookies", {
                  hasCheckbox: true,
                  keyPlaceholder: "cookie name",
                })
              );
              break;
            case "Auth":
              body.appendChild(createAuthView());
              break;
            case "Body":
              body.appendChild(createBodyView());
              break;
          }
        }

        function createKvView(items, stateKey, options = {}) {
          const container = document.createElement("div");
          container.className = "kv-container";
          items.forEach((item) => {
            const row = document.createElement("div");
            row.className = "param-row";
            let checkboxHtml = "";
            if (options.hasCheckbox) {
              checkboxHtml = `
                <label>
                    <input type="checkbox" data-id="${
                      item.id
                    }" data-field="enabled" ${item.enabled ? "checked" : ""}>
                    <span class="checkbox-container"><span class="checkmark">✓</span></span>
                </label>`;
            }
            row.innerHTML = `
                ${checkboxHtml}
                <input type="text" class="param-input" placeholder="${
                  options.keyPlaceholder || "key"
                }" value="${item.key}" data-id="${item.id}" data-field="key">
                <input type="text" class="param-input" placeholder="${
                  options.valuePlaceholder || "value"
                }" value="${item.value}" data-id="${
              item.id
            }" data-field="value">
                <button class="remove-button" data-id="${
                  item.id
                }">&#128465;</button>`; // Trash icon
            container.appendChild(row);
          });

          container.addEventListener("input", (e) => {
            if (e.target.matches(".param-input")) {
              const { id, field } = e.target.dataset;
              updateKvItem(stateKey, id, field, e.target.value);
            }
          });
          container.addEventListener("change", (e) => {
            if (e.target.matches('input[type="checkbox"]')) {
              const { id, field } = e.target.dataset;
              updateKvItem(stateKey, id, field, e.target.checked);
            }
          });
          container.addEventListener("click", (e) => {
            const removeBtn = e.target.closest(".remove-button");
            if (removeBtn) {
              removeKvItem(stateKey, removeBtn.dataset.id);
            }
          });

          return container;
        }

        function createHeadersView() {
          const container = document.createElement("div");
          container.style.cssText =
            "display:flex; flex-direction:column; height:100%;";
          const { isRawHeaders, rawHeadersText, headers } = appState;

          container.innerHTML = `
            <div class="raw-toggle-container">
                <label for="raw-headers-switch">Raw Input</label>
                <label class="switch">
                    <input type="checkbox" id="raw-headers-switch" ${
                      isRawHeaders ? "checked" : ""
                    }>
                    <span class="slider"></span>
                </label>
            </div>
            <div id="headers-content" style="flex: 1; display: flex; flex-direction: column;"></div>`;

          const contentDiv = container.querySelector("#headers-content");
          if (isRawHeaders) {
            const textArea = document.createElement("textarea");
            textArea.className = "raw-headers-input";
            textArea.value = rawHeadersText;
            textArea.placeholder = "HeaderName: HeaderValue";
            textArea.addEventListener("input", (e) => {
              appState.rawHeadersText = e.target.value;
              debouncedSave(appState);
            });
            contentDiv.appendChild(textArea);
          } else {
            contentDiv.appendChild(
              createKvView(headers, "headers", {
                hasCheckbox: true,
                keyPlaceholder: "header",
              })
            );
          }

          container
            .querySelector("#raw-headers-switch")
            .addEventListener("change", (e) => {
              appState.isRawHeaders = e.target.checked;
              if (appState.isRawHeaders) {
                appState.rawHeadersText = appState.headers
                  .filter((h) => h.key && h.enabled)
                  .map((h) => `${h.key}: ${h.value}`)
                  .join("\n");
              }
              render();
              debouncedSave(appState);
            });
          return container;
        }

        function createAuthView() {
          const container = document.createElement("div");
          container.style.cssText =
            "display:flex; flex-direction:column; height:100%;";
          const tabsContainer = document.createElement("div");
          tabsContainer.className = "sub-tab-container";
          const contentContainer = document.createElement("div");
          contentContainer.className = "sub-tab-content";
          container.append(tabsContainer, contentContainer);

          const authTabs = [
            "None",
            "Basic",
            "Bearer",
            // "OAuth 2.0", "AWS v4"
          ];
          renderSubTabs(
            tabsContainer,
            authTabs,
            appState.authConfig.type,
            (tab) => {
              appState.authConfig.type = tab;
              render();
              debouncedSave(appState);
            }
          );

          const {
            type,
            basic,
            bearer,
            //  oauth2, aws
          } = appState.authConfig;
          let contentHtml = "";
          switch (type) {
            case "Basic":
              contentHtml = `<input type="text" class="auth-input" placeholder="Username" data-section="basic" data-field="username" value="${
                basic.username || ""
              }"><input type="password" class="auth-input" placeholder="Password" data-section="basic" data-field="password" value="${
                basic.password || ""
              }">`;
              break;
            case "Bearer":
              contentHtml = `<input type="text" class="auth-input" placeholder="Token" data-section="bearer" data-field="token" value="${
                bearer.token || ""
              }">`;
              break;
            //   case "OAuth 2.0":
            //   contentHtml = `
            //     <p class="input-label" style="margin-bottom:10px;">Client Credentials Grant</p>
            //     <input type="text" class="auth-input" placeholder="Access Token URL" data-section="oauth2" data-field="tokenUrl" value="${
            //       oauth2.tokenUrl || ""
            //     }">
            //     <input type="text" class="auth-input" placeholder="Client ID" data-section="oauth2" data-field="clientId" value="${
            //       oauth2.clientId || ""
            //     }">
            //     <input type="password" class="auth-input" placeholder="Client Secret" data-section="oauth2" data-field="clientSecret" value="${
            //       oauth2.clientSecret || ""
            //     }">
            //     <input type="text" class="auth-input" placeholder="Scope (optional)" data-section="oauth2" data-field="scope" value="${
            //       oauth2.scope || ""
            //     }">
            //     <button class="send-button" id="fetch-oauth-token-btn" style="align-self: flex-start; margin-top: 5px; margin-bottom: 20px;">
            //       <span>Fetch Token</span>
            //     </button>
            //     <hr style="border-color: var(--border); width: 100%; margin: 15px 0;">
            //     <input type="text" class="auth-input" placeholder="Access Token" data-section="oauth2" data-field="accessToken" value="${
            //       oauth2.accessToken || ""
            //     }">`;
            //   break;
            // case "AWS v4":
            //   contentHtml = `<input type="text" class="auth-input" placeholder="Access Key ID" data-section="aws" data-field="accessKeyId" value="${
            //     aws.accessKeyId || ""
            //   }"><input type="password" class="auth-input" placeholder="Secret Access Key" data-section="aws" data-field="secretAccessKey" value="${
            //     aws.secretAccessKey || ""
            //   }"><input type="text" class="auth-input" placeholder="Region" data-section="aws" data-field="region" value="${
            //     aws.region || ""
            //   }"><input type="text" class="auth-input" placeholder="Service" data-section="aws" data-field="service" value="${
            //     aws.service || ""
            //   }">`;
            //   break;

            default:
              contentHtml = `<p>No authentication required.</p>`;
          }
          contentContainer.innerHTML = contentHtml;
          contentContainer.addEventListener("input", (e) => {
            if (e.target.matches(".auth-input")) {
              const { section, field } = e.target.dataset;
              appState.authConfig[section][field] = e.target.value;
              debouncedSave(appState);
            }
          });

          if (type === "OAuth 2.0") {
            const fetchBtn = contentContainer.querySelector(
              "#fetch-oauth-token-btn"
            );
            if (fetchBtn) {
              fetchBtn.addEventListener("click", fetchOAuthToken);
            }
          }

          return container;
        }

        function createBodyView() {
          const container = document.createElement("div");
          container.style.cssText =
            "display:flex; flex-direction:column; height:100%;";
          const tabsContainer = document.createElement("div");
          tabsContainer.className = "sub-tab-container";
          const contentContainer = document.createElement("div");
          contentContainer.className = "sub-tab-content";
          container.append(tabsContainer, contentContainer);

          const bodyTabs = [
            "JSON",
            "Text",
            "XML",
            "Form",
            "Form-encode",
            // "GraphQL",
            "Binary",
          ];
          renderSubTabs(
            tabsContainer,
            bodyTabs,
            appState.bodyConfig.type,
            (tab) => {
              appState.bodyConfig.type = tab;
              render();
              debouncedSave(appState);
            }
          );

          const {
            type,
            jsonContent,
            textContent,
            xmlContent,
            // graphqlQuery,
            // graphqlVariables,
            formData,
            formEncodedData,
            binaryFile,
          } = appState.bodyConfig;

          switch (type) {
            case "JSON": {
              const isJsonValid = isValidJson(jsonContent);
              contentContainer.innerHTML = `<div class="input-container"><div class="input-header"><span class="input-label">JSON</span><button class="prettify-button" id="prettify-json">Prettify</button></div><textarea id="json-content-input" class="json-input ${
                isJsonValid ? "" : "invalid"
              }">${jsonContent}</textarea></div>`;
              const input = contentContainer.querySelector(
                "#json-content-input"
              );
              input.addEventListener("input", () => {
                appState.bodyConfig.jsonContent = input.value;
                input.classList.toggle("invalid", !isValidJson(input.value));
                debouncedSave(appState);
              });
              contentContainer.querySelector("#prettify-json").onclick = () => {
                try {
                  const parsed = JSON.parse(appState.bodyConfig.jsonContent);
                  appState.bodyConfig.jsonContent = JSON.stringify(
                    parsed,
                    null,
                    2
                  );
                  render();
                  debouncedSave(appState);
                } catch (e) {
                  showToast("Invalid JSON. Cannot prettify.", "danger");
                }
              };
              break;
            }
            case "Text":
            case "XML": {
              const fieldKey = type === "Text" ? "textContent" : "xmlContent";
              contentContainer.innerHTML = `<div class="input-container"><div class="input-header"><span class="input-label">${type}</span></div><textarea class="json-input">${appState.bodyConfig[fieldKey]}</textarea></div>`;
              contentContainer
                .querySelector("textarea")
                .addEventListener("input", (e) => {
                  appState.bodyConfig[fieldKey] = e.target.value;
                  debouncedSave(appState);
                });
              break;
            }

            // case "GraphQL": {
            //   const isVarsValid = isValidJson(graphqlVariables);
            //   contentContainer.innerHTML = `<div style="display:flex; flex-direction:column; height:100%; gap:10px;"><div class="input-container" style="flex:1;"><div class="input-header"><span class="input-label">Query</span></div><textarea class="json-input" id="graphql-query-input" style="min-height:100px;">${graphqlQuery}</textarea></div><div class="input-container" style="flex:1;"><div class="input-header"><span class="input-label">Variables</span><button class="prettify-button" id="prettify-gql-vars">Prettify</button></div><textarea class="json-input ${
            //     isVarsValid ? "" : "invalid"
            //   }" id="graphql-vars-input" style="min-height:100px;">${graphqlVariables}</textarea></div></div>`;
            //   contentContainer
            //     .querySelector("#graphql-query-input")
            //     .addEventListener("input", (e) => {
            //       appState.bodyConfig.graphqlQuery = e.target.value;
            //       debouncedSave(appState);
            //     });
            //   const varsInput = contentContainer.querySelector(
            //     "#graphql-vars-input"
            //   );
            //   varsInput.addEventListener("input", () => {
            //     appState.bodyConfig.graphqlVariables = varsInput.value;
            //     varsInput.classList.toggle(
            //       "invalid",
            //       !isValidJson(varsInput.value)
            //     );
            //     debouncedSave(appState);
            //   });
            //   contentContainer.querySelector("#prettify-gql-vars").onclick =
            //     () => {
            //       try {
            //         const parsed = JSON.parse(
            //           appState.bodyConfig.graphqlVariables
            //         );
            //         appState.bodyConfig.graphqlVariables = JSON.stringify(
            //           parsed,
            //           null,
            //           2
            //         );
            //         render();
            //         debouncedSave(appState);
            //       } catch (e) {
            //         showToast("Invalid JSON in Variables.", "danger");
            //       }
            //     };
            //   break;
            // }

            case "Form-encode":
              contentContainer.appendChild(
                createKvView(formEncodedData, "formEncodedData", {
                  hasCheckbox: false,
                })
              );
              break;
            case "Form": {
              const kvContainer = document.createElement("div");
              kvContainer.className = "kv-container";
              formData.forEach((item) => {
                const row = document.createElement("div");
                row.className = "param-row";
                const valueInputHtml =
                  item.type === "file"
                    ? `<button class="file-button" data-id="${item.id}">${
                        item.file ? item.file.name : "Click To Select File"
                      }</button>`
                    : `<input type="text" class="param-input" placeholder="value" value="${item.value}" data-id="${item.id}" data-field="value">`;
                row.innerHTML = `<input type="text" class="param-input" placeholder="key" value="${
                  item.key
                }" data-id="${
                  item.id
                }" data-field="key">${valueInputHtml}<select class="form-type-dropdown" data-id="${
                  item.id
                }" data-field="type"><option value="text" ${
                  item.type === "text" ? "selected" : ""
                }>Text</option><option value="file" ${
                  item.type === "file" ? "selected" : ""
                }>File</option></select><button class="remove-button" data-id="${
                  item.id
                }">&#128465;</button>`;
                kvContainer.appendChild(row);
              });
              kvContainer.addEventListener("click", (e) => {
                const fileBtn = e.target.closest(".file-button");
                if (fileBtn) {
                  dom.formFilePicker.dataset.formId = fileBtn.dataset.id;
                  dom.formFilePicker.onchange = handleFormFilePick;
                  dom.formFilePicker.click();
                }
                const removeBtn = e.target.closest(".remove-button");
                if (removeBtn) {
                  removeKvItem("formData", removeBtn.dataset.id, "form");
                }
              });
              kvContainer.addEventListener("input", (e) => {
                if (e.target.matches(".param-input")) {
                  const { id, field } = e.target.dataset;
                  updateKvItem("formData", id, field, e.target.value);
                }
              });
              kvContainer.addEventListener("change", (e) => {
                if (e.target.matches(".form-type-dropdown")) {
                  const { id, field } = e.target.dataset;
                  updateKvItem("formData", id, field, e.target.value);
                }
              });
              contentContainer.appendChild(kvContainer);
              break;
            }
            case "Binary":
              contentContainer.innerHTML = `<div style="text-align: center;"><button class="send-button" id="binary-file-select">Select File</button><p id="binary-file-name" style="margin-top: 15px;">${
                binaryFile ? `Selected: ${binaryFile.name}` : ""
              }</p></div>`;
              contentContainer.querySelector("#binary-file-select").onclick =
                () => {
                  dom.formFilePicker.dataset.formId = "binary";
                  dom.formFilePicker.onchange = handleFormFilePick;
                  dom.formFilePicker.click();
                };
              break;
          }
          return container;
        }

        function renderResponseContent() {
          const body = dom.responsePanelBody;
          body.innerHTML = "";
          if (isLoading) {
            body.innerHTML = `<div class="response-body-container"><div style="margin:auto;"><div class="spinner"></div></div></div>`;
            return;
          }
          if (!responseState.status) {
            body.innerHTML = `<div class="response-body-container"><p class="promo-text">Click 'Send' to see the response.</p></div>`;
            return;
          }
          if (responseState.error) {
            body.innerHTML = `<div class="response-body-container" style="padding: 15px; align-items: flex-start;"><p style="color:var(--text-danger);">${responseState.data}</p></div>`;
          } else {
            switch (responseState.responseTab) {
              case "Response":
                const responseData =
                  typeof responseState.data === "string"
                    ? responseState.data
                    : JSON.stringify(responseState.data, null, 2);
                body.innerHTML = `<div class="response-body-container"><div class="copy-button-container"><button class="copy-button" id="copy-response-btn">Copy</button></div><textarea readonly>${responseData}</textarea></div>`;
                break;
              case "Headers":
                body.innerHTML = `<div class="response-body-container"><textarea readonly>${JSON.stringify(
                  responseState.headers,
                  null,
                  2
                )}</textarea></div>`;
                break;
              case "Cookies":
                const cookiesText =
                  responseState.cookies.length > 0
                    ? responseState.cookies.join("\n")
                    : "No cookies in response.";
                body.innerHTML = `<div class="response-body-container"><textarea readonly>${cookiesText}</textarea></div>`;
                break;
            }
            const copyBtn = body.querySelector("#copy-response-btn");
            if (copyBtn) copyBtn.onclick = handleCopyResponse;
          }
        }

        function renderResponseStatus() {
          const { status, size, time } = responseState;
          const statusColorClass = getStatusColorClass(status);
          const statusText =
            status === null
              ? "-"
              : status === "Error"
              ? "Error"
              : `${status} ${httpStatusMessages[status] || ""}`;
          dom.resStatus.textContent = statusText;
          dom.resStatus.className = `value ${statusColorClass}`;
          dom.resSize.textContent = formatBytes(size);
          dom.resSize.className = `value ${statusColorClass}`;
          dom.resTime.textContent = time !== null ? `${time} ms` : "-";
          dom.resTime.className = `value ${statusColorClass}`;
        }
        // ==================== Session Management Logic ====================
        const debouncedSave = debounce((stateToSave) => {
          if (!activeSessionKey) return;
          if (!stateToSave) return debouncedSaveMOD();

          try {
            const timestamp =
              sessions[activeSessionKey]?.timestamp || Date.now();
            const sessionToSave = {
              state: stateToSave,
              name: generateSessionName(stateToSave, timestamp),
              timestamp: timestamp,
            };
            sessions[activeSessionKey] = sessionToSave;

            vscode.postMessage({
              command: "saveToVSCodeState",
              payload: { key: activeSessionKey, state: sessionToSave },
            });
            const optionToUpdate = dom.sessionPicker.querySelector(
              `option[value="${activeSessionKey}"]`
            );
            if (optionToUpdate) optionToUpdate.textContent = sessionToSave.name;
          } catch (e) {
            console.error("Failed to save session.", e);
            showToast("Failed to save session.", "danger");
          }
        }, 1000);
        const debouncedSaveMOD = debounce(() => {
          if (!activeSessionKey) return;
          const timestamp = sessions[activeSessionKey]?.timestamp || Date.now();
          const sessionToSave = {
            state: appState,
            name: generateSessionName(appState, timestamp),
            timestamp: timestamp,
          };
          sessions[activeSessionKey] = sessionToSave; // Update local cache
          vscode.postMessage({
            command: "saveToVSCodeState",
            payload: { key: activeSessionKey, state: sessionToSave },
          });
        }, 1000);
        function loadAllSessions() {
          dom.initialLoader.style.display = "flex";
          vscode.postMessage({ command: "getAllStates" });
        }

        // async function initializeNewRequest(importedState = null) {
        //   const newKey = `${ASYNC_STORAGE_KEYS.SESSION_PREFIX}${Date.now()}`;
        //   const timestamp = Date.now();
        //   const newState = importedState || getDefaultState();
        //   const newSession = {
        //     state: newState,
        //     name: generateSessionName(newState, timestamp),
        //     timestamp: timestamp,
        //   };
        //   try {
        //     vscode.postMessage({
        //       command: "saveToVSCodeState",
        //       payload: { key: newKey, state: newSession, isNew: true },
        //     });
        //     sessions[newKey] = newSession;
        //     activeSessionKey = newKey;
        //     appState = newState;
        //     resetResponseState();
        //     renderSessionPicker();
        //     render();
        //     showToast(
        //       importedState ? "Session imported" : "New request created",
        //       "success"
        //     );
        //   } catch (e) {
        //     console.error("Failed to init new request.", e);
        //   }
        // }
        function initializeNewRequest(importedState = null) {
          const newKey = `session_${Date.now()}`;
          const timestamp = Date.now();
          const newState = importedState || getDefaultState();
          const newSession = {
            state: newState,
            name: generateSessionName(newState, timestamp),
            timestamp: timestamp,
          };

          vscode.postMessage({
            command: "saveToVSCodeState",
            payload: { key: newKey, state: newSession, isNew: true },
          });
          showToast("New Request Created Successfully.", "success");

          // The extension will send back a 'loadState' message after saving
          // which will trigger the UI update.
        }
        function switchActiveSession(key) {
          if (key && sessions[key]) {
            activeSessionKey = key;
            appState = sessions[key].state;
            vscode.setState({ activeSessionKey }); // Persist active key across reloads
            resetResponseState();
            render();
            dom.sessionPicker.value = key;
          }
        }

        function handleDeleteSession() {
          if (!activeSessionKey || !sessions[activeSessionKey]) {
            return;
          }

          // FIX: Removed the check that prevents deleting the last session.
          // if (Object.keys(sessions).length <= 1) {
          //   showToast("Cannot delete the last session.", "warning");
          //   return;
          // }

          try {
            vscode.postMessage({
              command: "deleteFromVSCodeState",
              payload: { key: activeSessionKey },
            });
            showToast("Session deleted", "success");

            // FIX: If no sessions are left, create a new one. Otherwise, switch to the newest one.
          } catch (e) {
            console.error("Failed to delete session.", e);
            showToast("Error deleting session.", "danger");
          }
        }

        function handleExport() {
          if (!activeSessionKey || !sessions[activeSessionKey]) return;
          try {
            const sessionJson = JSON.stringify(
              { state: sessions[activeSessionKey].state },
              null,
              2
            );
            vscode.postMessage({
              command: "exportState",
              payload: {
                content: sessionJson,
                fileName: `apicommander-session-${Date.now()}.json`,
              },
            });
            showToast("Session exported.", "success");
          } catch (e) {
            console.error("Export failed", e);
          }
        }

        function handleImport() {
          dom.fileImporter.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
              try {
                const parsed = JSON.parse(event.target.result);
                if (parsed.state && parsed.state.httpMethod)
                  await initializeNewRequest(parsed.state);
                else throw new Error("Invalid session file format.");
              } catch (err) {
                showToast(`Import failed: ${err.message}`, "danger");
              }
            };
            reader.readAsText(file);
            e.target.value = "";
          };
          dom.fileImporter.click();
        }

        function handleImport() {
          dom.fileImporter.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const parsed = JSON.parse(event.target.result);
                if (parsed.state && parsed.state.httpMethod) {
                  initializeNewRequest(parsed.state);
                } else {
                  throw new Error("Invalid session file format.");
                }
              } catch (err) {
                showToast(`Import failed: ${err.message}`, "danger");
              }
            };
            reader.readAsText(file);
            e.target.value = "";
          };
          dom.fileImporter.click();
        }

        function renderSessionPicker() {
          dom.sessionPicker.innerHTML = "";
          Object.keys(sessions)
            .map((key) => ({ key, ...sessions[key] }))
            .sort((a, b) => b.timestamp - a.timestamp)
            .forEach(({ key, name }) => {
              try {
                name = generateSessionName(
                  sessions[key].state,
                  sessions[key].timestamp
                );
              } catch (error) {
                console.log(error);
              }
              const option = document.createElement("option");
              option.value = key;
              option.textContent = name;
              dom.sessionPicker.appendChild(option);
            });
          if (activeSessionKey) {
            dom.sessionPicker.value = activeSessionKey;
          }
        }

        function generateSessionName(sessionState, timestamp) {
          const { httpMethod, url } = sessionState;
          const timeAgo = formatTimeAgo(timestamp);
          const shortUrl =
            url && url.length > 40 ? `${url.substring(0, 40)}...` : url;
          return `${httpMethod}: ${shortUrl || "[No URL]"} | ${timeAgo}`;
        }

        // ==================== Request/Response Logic ====================

        // async function fetchOAuthToken() {
        //   const { oauth2 } = appState.authConfig;
        //   vscode.postMessage({
        //     command: "fetchOauthToken",
        //     payload: {
        //       tokenUrl: oauth2.tokenUrl,
        //       clientId: oauth2.clientId,
        //       clientSecret: oauth2.clientSecret,
        //       scope: oauth2.scope,
        //     },
        //   });
        // }

        async function handleSend() {
          if (!validateRequest()) return;

          isLoading = true;
          render();
          resetResponseState(true);

          const payload = {
            method: appState.httpMethod,
            url: appState.url,
            params: appState.queryParams.filter((p) => p.enabled && p.key),
            headers: appState.headers
              .filter((h) => h.enabled && h.key)
              .reduce((acc, h) => {
                acc[h.key] = h.value;
                return acc;
              }, {}),
            authType: appState.authConfig.type.toLowerCase().split(" ")[0], // "None", "Basic", "Bearer", "OAuth 2.0", "AWS v4" -> "none", "basic", "bearer", "oauth", "aws"
            authDetails:
              appState.authConfig[
                appState.authConfig.type
                  .toLowerCase()
                  .split(" ")[0]
                  .replace("2.0", "2")
              ],
            bodyType: appState.bodyConfig.type.toLowerCase().replace("-", ""), // "Form-encode" -> "formencode"
            data: appState.bodyConfig,
          };

          vscode.postMessage({ command: "sendApiRequest", payload });
        }

        window.addEventListener("message", (event) => {
          const message = event.data;
          switch (message.command) {
            case "loadAllStates":
              sessions = message.payload.reduce((acc, session) => {
                acc[session.key] = session;
                return acc;
              }, {});
              renderSessionPicker();
              const savedState = vscode.getState();
              const keyToLoad =
                savedState &&
                savedState.activeSessionKey &&
                sessions[savedState.activeSessionKey]
                  ? savedState.activeSessionKey
                  : message.payload.length > 0
                  ? message.payload[0].key
                  : null;

              if (keyToLoad) {
                switchActiveSession(keyToLoad);
              } else {
                initializeNewRequest();
              }
              dom.initialLoader.style.display = "none";
              break;
            case "initializeNew":
              initializeNewRequest();
              break;
            case "loadState":
              const { key, ...stateData } = message.payload;
              sessions[key] = stateData; // Update the local session cache
              activeSessionKey = key; // Set the new key as active
              switchActiveSession(key); // Explicitly switch to the new session
              renderSessionPicker(); // Re-render the dropdown
              break;

            case "stateDeleted":
              delete sessions[message.payload.key];
              loadAllSessions(); // Reload all states to get the new list
              break;

            // case "apiRequestResult":
            //   isLoading = false;
            //   if (message.payload.error) {
            //     responseState = {
            //       data: message.payload.error,
            //       status: "Error",
            //       error: true,
            //       time: message.payload.responseTime || 0,
            //       headers: null,
            //       size: null,
            //       cookies: [],
            //     };
            //   } else {
            //     responseState = {
            //       ...message.payload,
            //       error: false,
            //       responseTab: "Response",
            //     };
            //   }
            //   render();
            //   break;
            // case "apiRequestResult":
            //   isLoading = false;
            //   if (message.payload.error) {
            //     responseState = {
            //       data: message.payload.error,
            //       status: "Error",
            //       error: true,
            //       time: message.payload.responseTime || 0,
            //       headers: null,
            //       size: null,
            //       cookies: [],
            //     };
            //   } else {
            //     responseState = {
            //       ...message.payload,
            //       error: false,
            //       responseTab: "Response",
            //     };
            //   }
            //   render();
            //   break;
            // Inside the <script> tag in index.html

            case "apiRequestResult":
              isLoading = false;
              if (message.payload.error) {
                responseState = {
                  data: message.payload.error,
                  status: "Error",
                  error: true,
                  time: message.payload.responseTime || 0,
                  headers: null,
                  size: null,
                  cookies: [],
                };
              } else {
                // FIX: Explicitly map responseTime to the 'time' property
                responseState = {
                  ...message.payload,
                  time: message.payload.responseTime, // Add this line
                  error: false,
                  responseTab: "Response",
                };
              }
              render();
              break;
            // case "oauthTokenResult":
            //   if (message.payload.error) {
            //     showToast(`OAuth Error: ${message.payload.error}`, "danger");
            //   } else {
            //     appState.authConfig.oauth2.accessToken = message.payload.token;
            //     showToast("OAuth Token Fetched!", "success");
            //     render();
            //     debouncedSave();
            //   }
            //   break;
          }
        });
        function validateRequest() {
          try {
            new URL(appState.url);
          } catch (e) {
            showToast("Invalid URL format.", "danger");
            return false;
          }
          if (
            appState.bodyConfig.type === "JSON" &&
            !isValidJson(appState.bodyConfig.jsonContent)
          ) {
            showToast("Invalid JSON in request body.", "danger");
            return false;
          }
          // if (
          //   appState.bodyConfig.type === "GraphQL" &&
          //   !isValidJson(appState.bodyConfig.graphqlVariables)
          // ) {
          //   showToast("GraphQL Variables are not valid JSON.", "danger");
          //   return false;
          // }
          if (
            appState.authConfig.type === "AWS v4" &&
            (!appState.authConfig.aws.accessKeyId ||
              !appState.authConfig.aws.secretAccessKey)
          ) {
            showToast("AWS v4 requires Access Key and Secret Key.", "danger");
            return false;
          }
          return true;
        }

        function handleCopyResponse() {
          if (responseState.data === null) return;
          const contentToCopy =
            typeof responseState.data === "string"
              ? responseState.data
              : JSON.stringify(responseState.data, null, 2);
          navigator.clipboard.writeText(contentToCopy).then(
            () => showToast("Response copied!", "success"),
            () => showToast("Failed to copy.", "danger")
          );
        }

        // ==================== Event Handlers & Helpers ====================
        function handleStateChange(key, value) {
          appState[key] = value;
          render();
          debouncedSave(appState);
        }

        function updateKvItem(stateKey, id, field, value) {
          let isLastRow = false;
          const items = appState[stateKey] || appState.bodyConfig[stateKey];
          const updatedItems = items.map((p, index) => {
            if (p.id == id) {
              if (index === items.length - 1) isLastRow = true;
              return { ...p, [field]: value };
            }
            return p;
          });
          if (
            isLastRow &&
            (updatedItems[updatedItems.length - 1].key ||
              updatedItems[updatedItems.length - 1].value ||
              updatedItems[updatedItems.length - 1].file)
          ) {
            updatedItems.push({
              ...(stateKey === "formData" ? emptyFormValue : emptyKeyValue),
              id: Date.now(),
            });
          }
          if (appState[stateKey]) appState[stateKey] = updatedItems;
          else appState.bodyConfig[stateKey] = updatedItems;
          if (updatedItems.length > items.length) render();
          debouncedSave(appState);
        }

        function removeKvItem(stateKey, id, type = "kv") {
          let items = appState[stateKey] || appState.bodyConfig[stateKey];
          let newItems = items.filter((p) => p.id != id);
          if (newItems.length === 0) {
            newItems.push({
              ...(type === "form" ? emptyFormValue : emptyKeyValue),
              id: Date.now(),
            });
          }
          if (appState[stateKey]) appState[stateKey] = newItems;
          else appState.bodyConfig[stateKey] = newItems;
          render();
          debouncedSave(appState);
        }

        function handleFormFilePick(e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (event) => {
            const fileData = {
              name: file.name,
              type: file.type,
              size: file.size,
              dataUrl: event.target.result,
            };
            if (e.target.dataset.formId === "binary")
              appState.bodyConfig.binaryFile = fileData;
            else
              updateKvItem(
                "formData",
                e.target.dataset.formId,
                "file",
                fileData
              );
            showToast(`Selected: ${file.name}`, "success");
            render();
            debouncedSave(appState);
          };
          reader.readAsDataURL(file);
          e.target.value = "";
        }

        function getStatusColorClass(status) {
          if (status === "Error" || status >= 500) return "error";
          if (status >= 400) return "warning";
          if (status >= 200 && status < 300) return "success";
          return "info";
        }

        function resetResponseState(isLoadingState = false) {
          responseState = {
            data: null,
            headers: null,
            status: null,
            size: null,
            time: null,
            error: null,
            responseTab: "Response",
            cookies: [],
          };
          if (!isLoadingState) isLoading = false;
          renderResponseContent();
          renderResponseStatus();
        }

        // ==================== Initialization ====================
        function init() {
          // Corrected Panel Resizing Logic
          let isResizing = false;

          const applyOrientation = () => {
            const isPortrait = window.innerHeight > window.innerWidth;
            dom.mainContent.style.flexDirection = isPortrait ? "column" : "row";
            dom.resizer.className = `resizer ${
              isPortrait ? "vertical" : "horizontal"
            }`;
            // Reset panel sizes on orientation change to avoid weird states
            dom.requestPanel.style.flex = "";
            dom.responsePanel.style.flex = "";
          };

          const startResize = (e) => {
            isResizing = true;
            const isPortrait = window.innerHeight > window.innerWidth;
            dom.body.style.cursor = isPortrait ? "row-resize" : "col-resize";
            dom.body.style.userSelect = "none";
          };

          const doResize = (e) => {
            if (!isResizing) return;
            const isPortrait = window.innerHeight > window.innerWidth;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const rect = dom.mainContent.getBoundingClientRect();
            let reqPanelSizePercent = isPortrait
              ? ((clientY - rect.top) / rect.height) * 100
              : ((clientX - rect.left) / rect.width) * 100;
            reqPanelSizePercent = Math.max(
              15,
              Math.min(85, reqPanelSizePercent)
            );
            dom.requestPanel.style.flex = `0 0 ${reqPanelSizePercent}%`;
            dom.responsePanel.style.flex = `0 0 ${100 - reqPanelSizePercent}%`;
          };

          const stopResize = () => {
            isResizing = false;
            dom.body.style.cursor = "default";
            document.body.style.userSelect = "auto";
          };

          applyOrientation(); // Set initial orientation on page load
          window.addEventListener("resize", applyOrientation);

          dom.resizer.addEventListener("mousedown", startResize);
          document.addEventListener("mousemove", doResize);
          document.addEventListener("mouseup", stopResize);
          dom.resizer.addEventListener("touchstart", startResize, {
            passive: true,
          });
          document.addEventListener("touchmove", doResize);
          document.addEventListener("touchend", stopResize);

          // Remaining event listeners
          dom.sessionPicker.addEventListener("change", (e) =>
            switchActiveSession(e.target.value)
          );
          dom.newSessionBtn.addEventListener("click", () =>
            initializeNewRequest()
          );
          dom.importSessionBtn.addEventListener("click", handleImport);
          dom.exportSessionBtn.addEventListener("click", handleExport);
          dom.deleteSessionBtn.addEventListener("click", handleDeleteSession);
          // dom.methodDropdown.addEventListener("change", (e) =>
          //   handleStateChange("httpMethod", e.target.value)
          // );
          // dom.urlInput.addEventListener("input", (e) => {
          //   appState.url = e.target.value;
          //   debouncedSave(appState);
          // });

          dom.methodDropdown.addEventListener("change", (e) =>
            handleStateChange("httpMethod", e.target.value)
          );

          // Corrected listener for the URL input
          dom.urlInput.addEventListener("input", (e) =>
            handleStateChange("url", e.target.value)
          );
          dom.sendBtn.addEventListener("click", handleSend);
          dom.requestTabContainer.addEventListener("click", (e) => {
            if (e.target.matches(".tab-button"))
              handleStateChange("requestTab", e.target.dataset.tab);
          });
          dom.responseTabContainer.addEventListener("click", (e) => {
            if (e.target.matches(".tab-button")) {
              responseState.responseTab = e.target.dataset.tab;
              render();
            }
          });

          loadAllSessions();
        }

        init();
      });
    </script>
  </body>
</html>
